<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watchlist</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header>
    <h1>Watchlist</h1>
    <div class="meta">
      {% if last_updated %}
        Last updated: {{ last_updated }}
      {% else %}
        No data yet - trigger a refresh below.
      {% endif %}
    </div>
    <button type="button" id="refresh-btn" {% if is_refreshing %}disabled{% endif %}>
      {% if is_refreshing %}Refreshing...{% else %}Refresh now{% endif %}
    </button>
  </header>

  <main>
    {% if not films %}
      <p class="empty">No films found. Click "Refresh now" to fetch your watchlist.</p>
    {% else %}

      {% if all_platforms %}
      <div class="my-services">
        <button type="button" class="my-services-label" id="manage-btn">My services</button>
        <div class="active-chips" id="active-chips"></div>
      </div>

      <dialog class="services-dialog" id="services-dialog" aria-labelledby="dialog-title">
        <div class="services-dialog-sheet">
          <div class="dialog-handle" aria-hidden="true"></div>
          <div class="services-dialog-header">
            <h2 class="services-dialog-title" id="dialog-title">Manage services</h2>
            <button type="button" class="dialog-close-btn" id="dialog-close" aria-label="Close">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="3" x2="15" y2="15"/><line x1="15" y1="3" x2="3" y2="15"/>
              </svg>
            </button>
          </div>
          <div class="services-quickactions">
            <button type="button" class="btn-link" id="dialog-all">Select all</button>
            <button type="button" class="btn-link" id="dialog-none">Deselect all</button>
          </div>
          <ul class="services-list">
            {% for p in all_platforms %}
            <li class="service-item">
              <label class="service-item-row">
                <input type="checkbox" class="service-checkbox" data-provider-id="{{ p.provider_id }}" />
                <div class="service-item-info">
                  {% if p.logo_path %}<img class="service-item-logo" src="{{ p.logo_path }}" alt="" />{% endif %}
                  <span class="service-item-name">{{ p.provider_name }}</span>
                </div>
                <span class="toggle-visual" aria-hidden="true"></span>
              </label>
            </li>
            {% endfor %}
          </ul>
          <div class="services-dialog-footer">
            <button type="button" class="done-btn" id="dialog-done">Done</button>
          </div>
        </div>
      </dialog>
      {% endif %}

      <section id="section-streaming" class="film-section" hidden>
        <h2 class="section-heading">Streaming on your services</h2>
        <ul class="film-grid" id="grid-streaming"></ul>
      </section>

      <section id="section-other" class="film-section" hidden>
        <h2 class="section-heading section-heading--dim">Everything else</h2>
        <ul class="film-grid" id="grid-other"></ul>
      </section>

      <ul class="film-grid" id="grid-all">
        {% for film in films %}
        <li
          class="film-card"
          data-platform-ids="{{ film.streaming_platforms | map(attribute='provider_id') | join(',') }}"
          data-index="{{ loop.index0 }}"
        >
          {% if film.poster_url %}
            <img src="{{ film.poster_url }}" alt="{{ film.title }}" loading="lazy" />
          {% else %}
            <div class="no-poster">No poster</div>
          {% endif %}
          <div class="film-info">
            <h3>{{ film.title }}{% if film.year %} <span class="year">({{ film.year }})</span>{% endif %}</h3>
            {% if film.streaming_platforms %}
              <ul class="platforms">
                {% for platform in film.streaming_platforms %}
                <li data-provider-id="{{ platform.provider_id }}">
                  {% if platform.logo_path %}
                    <img src="{{ platform.logo_path }}" alt="" />
                    <span>{{ platform.provider_name }}</span>
                  {% else %}
                    <span>{{ platform.provider_name }}</span>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
            {% elif film.tmdb_status == "not_found" %}
              <p class="unavailable">Not found on TMDB</p>
            {% else %}
              <p class="unavailable">Not streaming in {{ film.country }}</p>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>

    {% endif %}
  </main>

  <script>
  (function () {
    var STORAGE_KEY = 'watchlist_disabled_services';

    var checkboxes = Array.from(document.querySelectorAll('.service-checkbox'));
    var allIds = checkboxes.map(function (cb) { return parseInt(cb.dataset.providerId); });

    // Build provider info map from the dialog's rendered list items
    var providerInfo = {};
    document.querySelectorAll('.service-item').forEach(function (item) {
      var cb = item.querySelector('.service-checkbox');
      var id = parseInt(cb.dataset.providerId);
      var name = item.querySelector('.service-item-name').textContent.trim();
      var img = item.querySelector('.service-item-logo');
      providerInfo[id] = { name: name, logoSrc: img ? img.src : '' };
    });

    function loadEnabled() {
      try {
        var stored = localStorage.getItem(STORAGE_KEY);
        if (stored === null) return new Set(allIds);
        var disabled = new Set(JSON.parse(stored));
        return new Set(allIds.filter(function (id) { return !disabled.has(id); }));
      } catch (_) {
        return new Set(allIds);
      }
    }

    function saveEnabled(enabled) {
      var disabled = allIds.filter(function (id) { return !enabled.has(id); });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(disabled));
    }

    var enabled = loadEnabled();

    function applyActiveChips() {
      var container = document.getElementById('active-chips');
      if (!container) return;
      container.innerHTML = '';
      var activeIds = allIds.filter(function (id) { return enabled.has(id); });
      if (activeIds.length === 0) {
        var hint = document.createElement('span');
        hint.className = 'no-services-hint';
        hint.textContent = 'None selected';
        container.appendChild(hint);
        return;
      }
      activeIds.forEach(function (id) {
        var info = providerInfo[id];
        if (!info) return;
        var chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'service-chip';
        chip.addEventListener('click', function () { dialog.showModal(); });
        if (info.logoSrc) {
          var img = document.createElement('img');
          img.src = info.logoSrc;
          img.alt = '';
          chip.appendChild(img);
        }
        var nameSpan = document.createElement('span');
        nameSpan.textContent = info.name;
        chip.appendChild(nameSpan);
        container.appendChild(chip);
      });
    }

    function applyDialogStates() {
      checkboxes.forEach(function (cb) {
        cb.checked = enabled.has(parseInt(cb.dataset.providerId));
      });
    }

    function classify() {
      var gridAll = document.getElementById('grid-all');
      var sectionStreaming = document.getElementById('section-streaming');
      var sectionOther = document.getElementById('section-other');
      var gridStreaming = document.getElementById('grid-streaming');
      var gridOther = document.getElementById('grid-other');

      if (!gridAll) return;

      var allCards = Array.from(document.querySelectorAll('.film-card'));
      var allEnabled = allIds.length === 0 || allIds.every(function (id) { return enabled.has(id); });

      if (allEnabled) {
        allCards.sort(function (a, b) { return parseInt(a.dataset.index) - parseInt(b.dataset.index); });
        allCards.forEach(function (card) { gridAll.appendChild(card); });
        if (sectionStreaming) sectionStreaming.hidden = true;
        if (sectionOther) sectionOther.hidden = true;
        gridAll.hidden = false;
      } else {
        var streaming = [], other = [];
        allCards.forEach(function (card) {
          var raw = card.dataset.platformIds || '';
          var ids = raw.split(',').filter(Boolean).map(Number);
          var matches = ids.some(function (id) { return enabled.has(id); });
          (matches ? streaming : other).push(card);
        });
        function byIndex(a, b) { return parseInt(a.dataset.index) - parseInt(b.dataset.index); }
        streaming.sort(byIndex);
        other.sort(byIndex);
        if (gridStreaming) streaming.forEach(function (c) { gridStreaming.appendChild(c); });
        if (gridOther) other.forEach(function (c) { gridOther.appendChild(c); });
        gridAll.hidden = true;
        if (sectionStreaming) sectionStreaming.hidden = streaming.length === 0;
        if (sectionOther) sectionOther.hidden = other.length === 0;
      }
    }

    function filterPlatforms() {
      document.querySelectorAll('#grid-streaming .platforms li[data-provider-id], #grid-all .platforms li[data-provider-id]').forEach(function (li) {
        li.hidden = !enabled.has(parseInt(li.dataset.providerId));
      });
      document.querySelectorAll('#grid-other .platforms li[data-provider-id]').forEach(function (li) {
        li.hidden = false;
      });
    }

    function update() {
      applyActiveChips();
      applyDialogStates();
      classify();
      filterPlatforms();
      saveEnabled(enabled);
    }

    // --- Dialog ---
    var dialog = document.getElementById('services-dialog');
    var manageBtn = document.getElementById('manage-btn');
    var closeBtn = document.getElementById('dialog-close');
    var doneBtn = document.getElementById('dialog-done');
    var dialogAll = document.getElementById('dialog-all');
    var dialogNone = document.getElementById('dialog-none');
    var dialogSheet = dialog ? dialog.querySelector('.services-dialog-sheet') : null;

    if (manageBtn && dialog) {
      manageBtn.addEventListener('click', function () { dialog.showModal(); });
    }
    if (closeBtn) closeBtn.addEventListener('click', function () { dialog.close(); });
    if (doneBtn) doneBtn.addEventListener('click', function () { dialog.close(); });

    // Close on backdrop click (clicks on the dialog element outside its sheet)
    if (dialog && dialogSheet) {
      dialogSheet.addEventListener('click', function (e) { e.stopPropagation(); });
      dialog.addEventListener('click', function () { dialog.close(); });
    }

    if (dialogAll) dialogAll.addEventListener('click', function () { enabled = new Set(allIds); update(); });
    if (dialogNone) dialogNone.addEventListener('click', function () { enabled = new Set(); update(); });

    checkboxes.forEach(function (cb) {
      cb.addEventListener('change', function () {
        var id = parseInt(cb.dataset.providerId);
        if (cb.checked) { enabled.add(id); } else { enabled.delete(id); }
        update();
      });
    });

    update();
  })();

  // --- Refresh button ---
  (function () {
    var btn = document.getElementById('refresh-btn');
    if (!btn) return;

    var pollInterval = null;

    function setRefreshing(on) {
      btn.disabled = on;
      btn.textContent = on ? 'Refreshing...' : 'Refresh now';
    }

    function pollUntilDone() {
      pollInterval = setInterval(function () {
        fetch('/status').then(function (r) { return r.json(); }).then(function (data) {
          if (!data.is_refreshing) {
            clearInterval(pollInterval);
            window.location.reload();
          }
        }).catch(function () { clearInterval(pollInterval); setRefreshing(false); });
      }, 2000);
    }

    // If the page loaded while already refreshing, start polling immediately
    if (btn.disabled) {
      pollUntilDone();
    }

    btn.addEventListener('click', function () {
      setRefreshing(true);
      fetch('/refresh', { method: 'POST' })
        .then(function (r) { return r.json(); })
        .then(function () { pollUntilDone(); })
        .catch(function () { setRefreshing(false); });
    });
  })();
  </script>
</body>
</html>

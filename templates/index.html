<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watchlist</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#256af4",
            "background-dark": "#101622",
            "background-light": "#f5f6f8",
          },
          fontFamily: { "display": ["Inter", "sans-serif"] },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
        },
      },
    }
  </script>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen" style="font-family: 'Inter', sans-serif;">
<div class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-50 glass-panel border-b border-white/10 px-6 py-4 lg:px-20">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
      <!-- Logo + title -->
      <div class="flex items-center gap-3 shrink-0">
        <div class="bg-primary p-2 rounded-lg flex items-center justify-center">
          <span class="material-symbols-outlined text-white" style="font-size:20px">movie_filter</span>
        </div>
        <span class="text-slate-100 text-lg font-bold tracking-tight">Watchlist</span>
      </div>

      <!-- Search -->
      <div class="hidden md:flex flex-1 max-w-md">
        <div class="relative w-full">
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 select-none" style="font-size:18px">search</span>
          <input
            id="search-input"
            type="text"
            placeholder="Search your library..."
            class="w-full bg-white/5 border border-white/10 rounded-lg py-2 pl-10 pr-4 text-slate-200 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all text-sm"
          />
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-3 shrink-0">
        <span class="hidden lg:block text-slate-500 text-xs">
          {% if is_refreshing %}
            Refreshing…
          {% elif last_updated %}
            Updated {{ last_updated }}
          {% endif %}
        </span>

        <button
          type="button"
          id="refresh-btn"
          {% if is_refreshing %}disabled{% endif %}
          class="flex items-center gap-2 px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition-colors text-slate-200 font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span class="material-symbols-outlined" style="font-size:18px">refresh</span>
          <span class="hidden sm:inline">{% if is_refreshing %}Refreshing…{% else %}Refresh{% endif %}</span>
        </button>

        <div class="w-9 h-9 rounded-full border border-white/20 bg-primary/20 flex items-center justify-center text-slate-100 font-semibold text-sm select-none uppercase">
          {{ username[0] if username else '?' }}
        </div>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto w-full px-6 lg:px-20 py-8 space-y-8 flex-1">

    {% if not films %}
      <div class="text-center text-slate-600 mt-24">
        <span class="material-symbols-outlined block mb-3 text-slate-700" style="font-size:48px">movie_filter</span>
        <p>No films yet. Click <strong class="text-slate-400">Refresh</strong> to fetch your watchlist.</p>
      </div>
    {% else %}

      <!-- My Services -->
      {% if all_platforms %}
      <section class="space-y-3">
        <div class="flex items-center justify-between">
          <button
            type="button"
            id="manage-btn"
            class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-primary/90 transition-colors shadow-lg shadow-primary/20"
          >My Services</button>
        </div>
        <div id="active-chips" class="flex gap-3 overflow-x-auto pb-1 no-scrollbar"></div>

        <dialog class="services-dialog" id="services-dialog" aria-labelledby="dialog-title">
          <div class="services-dialog-sheet">
            <div class="dialog-handle" aria-hidden="true"></div>
            <div class="services-dialog-header">
              <h2 class="services-dialog-title" id="dialog-title">Manage services</h2>
              <button type="button" class="dialog-close-btn" id="dialog-close" aria-label="Close">
                <span class="material-symbols-outlined" style="font-size:18px">close</span>
              </button>
            </div>
            <div class="services-quickactions">
              <button type="button" class="btn-link" id="dialog-all">Select all</button>
              <button type="button" class="btn-link" id="dialog-none">Deselect all</button>
            </div>
            <ul class="services-list">
              {% for p in all_platforms %}
              <li class="service-item">
                <label class="service-item-row">
                  <input type="checkbox" class="service-checkbox" data-provider-id="{{ p.provider_id }}" />
                  <div class="service-item-info">
                    {% if p.logo_path %}<img class="service-item-logo" src="{{ p.logo_path }}" alt="" />{% endif %}
                    <span class="service-item-name">{{ p.provider_name }}</span>
                  </div>
                  <span class="toggle-visual" aria-hidden="true"></span>
                </label>
              </li>
              {% endfor %}
            </ul>
            <div class="services-dialog-footer">
              <button type="button" class="done-btn" id="dialog-done">Done</button>
            </div>
          </div>
        </dialog>
      </section>
      {% endif %}

      <!-- Streaming section (shown when services filtered) -->
      <section id="section-streaming" class="space-y-6" hidden>
        <div class="flex items-end justify-between">
          <h1 class="text-2xl font-bold text-slate-100">Streaming on your services</h1>
          <div class="flex gap-2" data-view-toggle-group>
            <button type="button" data-view-mode-btn="grid" class="p-2 glass-panel rounded-lg hover:bg-white/10 text-slate-300" aria-label="Grid view">
              <span class="material-symbols-outlined" style="font-size:20px">grid_view</span>
            </button>
            <button type="button" data-view-mode-btn="list" class="p-2 glass-panel rounded-lg hover:bg-white/10 text-slate-500" aria-label="List view">
              <span class="material-symbols-outlined" style="font-size:20px">list</span>
            </button>
          </div>
        </div>
        <ul class="film-items film-items-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 list-none p-0 m-0" id="grid-streaming"></ul>
      </section>

      <!-- Everything else section -->
      <section id="section-other" class="space-y-6" hidden>
        <div class="flex items-end justify-between">
          <h1 class="text-2xl font-bold text-slate-100">Everything else</h1>
        </div>
        <ul class="film-items film-items-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 list-none p-0 m-0" id="grid-other"></ul>
      </section>

      <!-- All films grid (default/unfiltered) -->
      <section id="section-all" class="space-y-6">
        <div class="flex items-end justify-between">
          <h1 class="text-2xl font-bold text-slate-100">Your watchlist</h1>
          <div class="flex gap-2" data-view-toggle-group>
            <button type="button" data-view-mode-btn="grid" class="p-2 glass-panel rounded-lg hover:bg-white/10 text-slate-300" aria-label="Grid view">
              <span class="material-symbols-outlined" style="font-size:20px">grid_view</span>
            </button>
            <button type="button" data-view-mode-btn="list" class="p-2 glass-panel rounded-lg hover:bg-white/10 text-slate-500" aria-label="List view">
              <span class="material-symbols-outlined" style="font-size:20px">list</span>
            </button>
          </div>
        </div>
        <ul class="film-items film-items-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 list-none p-0 m-0" id="grid-all">
          {% for film in films %}
          <li
            class="film-card group cursor-pointer"
            data-film-popup-trigger="true"
            tabindex="0"
            role="button"
            aria-label="Open details for {{ film.title }}"
            data-film-title="{{ film.title }}"
            data-film-year="{{ film.year or '' }}"
            data-film-genres="{{ film.genres | join('||') }}"
            data-runtime-minutes="{{ film.runtime_minutes or '' }}"
            data-original-language="{{ film.original_language or '' }}"
            data-certification=""
            data-overview="{{ (film.overview or '') | replace('\n', ' ') }}"
            data-watch-link="{{ film.watch_link or '' }}"
            data-platform-ids="{{ film.streaming_platforms | map(attribute='provider_id') | join(',') }}"
            data-platform-names="{{ film.streaming_platforms | map(attribute='provider_name') | join('||') }}"
            data-index="{{ loop.index0 }}"
            data-title="{{ film.title | lower }}"
          >
            <div class="film-card-grid-view">
              <!-- Poster -->
              <div class="relative aspect-[2/3] w-full overflow-hidden rounded-xl border border-white/5 transition-all duration-300 group-hover:border-primary/50 group-hover:shadow-[0_0_20px_rgba(37,106,244,0.2)]">
                {% if film.poster_url %}
                  <img src="{{ film.poster_url }}" alt="{{ film.title }}" loading="lazy"
                       class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                {% else %}
                  <div class="w-full h-full bg-white/5 flex items-center justify-center text-slate-600 text-xs">No poster</div>
                {% endif %}

              </div>

              <!-- Film info -->
              <div class="mt-2 space-y-1 px-0.5">
                <h4 class="text-slate-100 font-semibold text-sm truncate">{{ film.title }}</h4>
                <div class="flex items-center justify-between gap-1">
                  <span class="text-slate-400 text-xs truncate">
                    {%- if film.genres %}{{ film.genres[0] }}{% endif -%}
                    {%- if film.genres and film.year %} • {% endif -%}
                    {%- if film.year %}{{ film.year }}{% endif -%}
                  </span>
                  {% if film.streaming_platforms %}
                    {% set p = film.streaming_platforms[0] %}
                    <span class="platform-summary shrink-0 inline-flex items-center gap-1">
                      <span class="platform-badge shrink-0 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase"
                            data-provider-id="{{ p.provider_id }}">
                        {{ p.provider_name }}
                      </span>
                      <span class="platform-extra text-[10px] text-slate-400 font-semibold" hidden></span>
                    </span>
                  {% elif film.tmdb_status == "not_found" %}
                    <span class="text-[10px] text-slate-600">Not on TMDB</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="film-card-list-view">
              <div class="film-list-row glass-panel rounded-xl border border-white/5 px-3 py-2">
                <div class="film-list-thumb" aria-hidden="true">
                  {% if film.poster_url %}
                    <img src="{{ film.poster_url }}" alt="" loading="lazy" class="w-full h-full object-cover rounded-md" />
                  {% else %}
                    <div class="w-full h-full bg-white/5 rounded-md flex items-center justify-center text-[10px] text-slate-600">No poster</div>
                  {% endif %}
                </div>
                <div class="film-list-title-col min-w-0">
                  <div class="film-list-col-label">Title</div>
                  <div class="film-list-title text-slate-100 font-semibold leading-tight truncate">{{ film.title }}</div>
                </div>
                <div class="film-list-year-col min-w-0">
                  <div class="film-list-col-label">Year</div>
                  <div class="text-sm text-slate-300 truncate">{{ film.year or '—' }}</div>
                </div>
                <div class="film-list-genre-col min-w-0">
                  <div class="film-list-col-label">Genre</div>
                  <div class="text-sm text-slate-300 truncate">{{ film.genres[0] if film.genres else '—' }}</div>
                </div>
                <div class="film-list-services-col min-w-0">
                  <div class="film-list-col-label">Services</div>
                  <div class="film-list-services flex flex-wrap gap-1.5" data-list-services></div>
                </div>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </section>

      <dialog class="services-dialog" id="film-dialog" aria-labelledby="film-dialog-title">
        <div class="services-dialog-sheet max-w-2xl">
          <div class="dialog-handle" aria-hidden="true"></div>
          <div class="services-dialog-header">
            <h2 class="services-dialog-title" id="film-dialog-title">Film details</h2>
            <button type="button" class="dialog-close-btn" id="film-dialog-close" aria-label="Close film details">
              <span class="material-symbols-outlined" style="font-size:18px">close</span>
            </button>
          </div>

          <div class="px-4 sm:px-5 pb-5 space-y-4">
            <div class="space-y-2">
              <div id="film-dialog-meta-primary" class="flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-slate-300">
                <span id="film-dialog-year" hidden></span>
                <span id="film-dialog-genres" hidden></span>
              </div>
              <div id="film-dialog-meta-secondary" class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-slate-400">
                <span id="film-dialog-runtime-wrap" hidden>Runtime: <span id="film-dialog-runtime"></span></span>
                <span id="film-dialog-language-wrap" hidden>Language: <span id="film-dialog-language"></span></span>
                <span id="film-dialog-certification-wrap" hidden>Certification: <span id="film-dialog-certification"></span></span>
              </div>
            </div>

            <section class="space-y-2">
              <h3 class="text-sm font-semibold text-slate-200">Streaming services</h3>
              <div id="film-dialog-services-active-wrap" class="space-y-2" hidden>
                <div class="text-[11px] font-semibold uppercase tracking-wide text-primary">On your services</div>
                <div id="film-dialog-services-active" class="flex flex-wrap gap-2"></div>
              </div>
              <div id="film-dialog-services-other-wrap" class="space-y-2" hidden>
                <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Other services</div>
                <div id="film-dialog-services-other" class="flex flex-wrap gap-2"></div>
              </div>
              <p id="film-dialog-services-empty" class="text-xs text-slate-500" hidden>No streaming services listed.</p>
            </section>

            <section class="space-y-2">
              <h3 class="text-sm font-semibold text-slate-200">Synopsis</h3>
              <p id="film-dialog-synopsis" class="text-sm leading-6 text-slate-300"></p>
            </section>

            <div class="pt-1">
              <a id="film-dialog-tmdb-link" href="#" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center gap-2 px-3 py-2 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined" style="font-size:18px">open_in_new</span>
                <span>TMDB</span>
              </a>
            </div>
          </div>
        </div>
      </dialog>

    {% endif %}
  </main>
</div>

<script>
(function () {
  var STORAGE_KEY = 'watchlist_disabled_services';
  var VIEW_MODE_KEY = 'watchlist_view_mode';

  var checkboxes = Array.from(document.querySelectorAll('.service-checkbox'));
  var allIds = checkboxes.map(function (cb) { return parseInt(cb.dataset.providerId); });
  var viewModeButtons = Array.from(document.querySelectorAll('[data-view-mode-btn]'));
  var viewMode = loadViewMode();

  // Build provider info map from the dialog's rendered list items
  var providerInfo = {};
  document.querySelectorAll('.service-item').forEach(function (item) {
    var cb = item.querySelector('.service-checkbox');
    var id = parseInt(cb.dataset.providerId);
    var name = item.querySelector('.service-item-name').textContent.trim();
    var img = item.querySelector('.service-item-logo');
    providerInfo[id] = { name: name, logoSrc: img ? img.src : '' };
  });

  function loadEnabled() {
    try {
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored === null) return new Set(allIds);
      var disabled = new Set(JSON.parse(stored));
      return new Set(allIds.filter(function (id) { return !disabled.has(id); }));
    } catch (_) {
      return new Set(allIds);
    }
  }

  function saveEnabled(enabled) {
    var disabled = allIds.filter(function (id) { return !enabled.has(id); });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(disabled));
  }

  function loadViewMode() {
    try {
      var stored = localStorage.getItem(VIEW_MODE_KEY);
      return (stored === 'list' || stored === 'grid') ? stored : 'grid';
    } catch (_) {
      return 'grid';
    }
  }

  function saveViewMode(mode) {
    try {
      localStorage.setItem(VIEW_MODE_KEY, mode);
    } catch (_) {}
  }

  var enabled = loadEnabled();

  function applyActiveChips() {
    var container = document.getElementById('active-chips');
    if (!container) return;
    container.innerHTML = '';
    var activeIds = allIds.filter(function (id) { return enabled.has(id); });
    if (activeIds.length === 0) {
      var hint = document.createElement('span');
      hint.className = 'no-services-hint';
      hint.textContent = 'None selected';
      container.appendChild(hint);
      return;
    }
    activeIds.forEach(function (id) {
      var info = providerInfo[id];
      if (!info) return;
      var chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'service-chip';
      chip.addEventListener('click', function () { dialog.showModal(); });
      if (info.logoSrc) {
        var img = document.createElement('img');
        img.src = info.logoSrc;
        img.alt = '';
        chip.appendChild(img);
      }
      var nameSpan = document.createElement('span');
      nameSpan.textContent = info.name;
      chip.appendChild(nameSpan);
      container.appendChild(chip);
    });
  }

  function applyDialogStates() {
    checkboxes.forEach(function (cb) {
      cb.checked = enabled.has(parseInt(cb.dataset.providerId));
    });
  }

  function classify() {
    var gridAll = document.getElementById('grid-all');
    var sectionStreaming = document.getElementById('section-streaming');
    var sectionOther = document.getElementById('section-other');
    var sectionAll = document.getElementById('section-all');
    var gridStreaming = document.getElementById('grid-streaming');
    var gridOther = document.getElementById('grid-other');

    if (!gridAll) return;

    var allCards = Array.from(document.querySelectorAll('.film-card'));
    var allEnabled = allIds.length === 0 || allIds.every(function (id) { return enabled.has(id); });

    if (allEnabled) {
      allCards.sort(function (a, b) { return parseInt(a.dataset.index) - parseInt(b.dataset.index); });
      allCards.forEach(function (card) { gridAll.appendChild(card); });
      if (sectionStreaming) sectionStreaming.hidden = true;
      if (sectionOther) sectionOther.hidden = true;
      if (sectionAll) sectionAll.hidden = false;
      gridAll.hidden = false;
    } else {
      var streaming = [], other = [];
      allCards.forEach(function (card) {
        var raw = card.dataset.platformIds || '';
        var ids = raw.split(',').filter(Boolean).map(Number);
        var matches = ids.some(function (id) { return enabled.has(id); });
        (matches ? streaming : other).push(card);
      });
      function byIndex(a, b) { return parseInt(a.dataset.index) - parseInt(b.dataset.index); }
      streaming.sort(byIndex);
      other.sort(byIndex);
      if (gridStreaming) streaming.forEach(function (c) { gridStreaming.appendChild(c); });
      if (gridOther) other.forEach(function (c) { gridOther.appendChild(c); });
      gridAll.hidden = true;
      if (sectionAll) sectionAll.hidden = true;
      if (sectionStreaming) sectionStreaming.hidden = streaming.length === 0;
      if (sectionOther) sectionOther.hidden = other.length === 0;
    }
  }

  function filterPlatforms() {
    document.querySelectorAll('#grid-streaming .platforms li[data-provider-id], #grid-all .platforms li[data-provider-id]').forEach(function (li) {
      li.hidden = !enabled.has(parseInt(li.dataset.providerId));
    });
    document.querySelectorAll('#grid-other .platforms li[data-provider-id]').forEach(function (li) {
      li.hidden = false;
    });
  }

  function getCardPlatforms(card) {
    var ids = (card.dataset.platformIds || '').split(',').filter(Boolean).map(Number);
    var names = (card.dataset.platformNames || '').split('||');
    return ids.map(function (id, i) {
      return { provider_id: id, provider_name: names[i] || '' };
    });
  }

  function getRelevantPlatforms(card) {
    var platforms = getCardPlatforms(card);
    var parentId = card.parentElement ? card.parentElement.id : '';
    if (parentId === 'grid-streaming') {
      return platforms.filter(function (p) { return enabled.has(p.provider_id); });
    }
    // "Everything else" and default "all" view show all services on the film.
    return platforms;
  }

  function renderListPlatformSummaries() {
    document.querySelectorAll('.film-card').forEach(function (card) {
      var target = card.querySelector('[data-list-services]');
      if (!target) return;

      var relevant = getRelevantPlatforms(card);
      if (!relevant.length) {
        target.innerHTML = '<span class="text-xs text-slate-500">No services</span>';
        return;
      }

      target.innerHTML = relevant.map(function (p) {
        return '<span class="platform-badge film-list-service-badge text-[10px] font-semibold px-2 py-1 rounded whitespace-nowrap" data-provider-id="' +
          String(p.provider_id) + '">' + escapeText(p.provider_name) + '</span>';
      }).join('');
    });
  }

  function syncViewModeButtons() {
    viewModeButtons.forEach(function (btn) {
      var active = btn.dataset.viewModeBtn === viewMode;
      btn.classList.toggle('text-slate-300', active);
      btn.classList.toggle('text-slate-500', !active);
      btn.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
  }

  function applyViewMode() {
    document.querySelectorAll('.film-items').forEach(function (container) {
      container.classList.toggle('film-items-list', viewMode === 'list');
      container.classList.toggle('film-items-grid', viewMode !== 'list');
    });

    document.querySelectorAll('.film-card').forEach(function (card) {
      card.classList.toggle('view-list', viewMode === 'list');
      card.classList.toggle('view-grid', viewMode !== 'list');
    });

    syncViewModeButtons();
  }

  function updatePlatformSummaries() {
    document.querySelectorAll('.film-card').forEach(function (card) {
      var summary = card.querySelector('.platform-summary');
      if (!summary) return;

      var badge = summary.querySelector('.platform-badge');
      var extra = summary.querySelector('.platform-extra');
      if (!badge || !extra) return;

      var relevant = getRelevantPlatforms(card);
      if (!relevant.length) {
        summary.hidden = true;
        return;
      }

      summary.hidden = false;
      badge.textContent = relevant[0].provider_name;
      badge.dataset.providerId = String(relevant[0].provider_id);

      if (relevant.length > 1) {
        extra.textContent = '+' + (relevant.length - 1);
        extra.hidden = false;
      } else {
        extra.textContent = '';
        extra.hidden = true;
      }
    });

    renderListPlatformSummaries();
    if (window.applyPlatformBadgeColours) window.applyPlatformBadgeColours(document);
  }

  function escapeText(text) {
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderServiceChip(provider, primary) {
    var cls = 'platform-badge film-list-service-badge text-[10px] font-semibold px-2 py-1 rounded whitespace-nowrap';
    return '<span class="' + cls + '" data-provider-id="' + String(provider.provider_id) + '">' + escapeText(provider.provider_name) + '</span>';
  }

  function formatRuntime(minutes) {
    var n = parseInt(minutes, 10);
    if (!n) return '';
    var h = Math.floor(n / 60);
    var m = n % 60;
    if (h && m) return h + 'h ' + m + 'm';
    if (h) return h + 'h';
    return m + 'm';
  }

  function formatLanguage(code) {
    if (!code) return '';
    return String(code).toUpperCase();
  }

  function openFilmDialog(card) {
    var filmDialog = document.getElementById('film-dialog');
    if (!filmDialog) return;

    var titleEl = document.getElementById('film-dialog-title');
    var yearEl = document.getElementById('film-dialog-year');
    var genresEl = document.getElementById('film-dialog-genres');
    var runtimeWrap = document.getElementById('film-dialog-runtime-wrap');
    var runtimeEl = document.getElementById('film-dialog-runtime');
    var languageWrap = document.getElementById('film-dialog-language-wrap');
    var languageEl = document.getElementById('film-dialog-language');
    var certificationWrap = document.getElementById('film-dialog-certification-wrap');
    var certificationEl = document.getElementById('film-dialog-certification');
    var activeWrap = document.getElementById('film-dialog-services-active-wrap');
    var activeEl = document.getElementById('film-dialog-services-active');
    var otherWrap = document.getElementById('film-dialog-services-other-wrap');
    var otherEl = document.getElementById('film-dialog-services-other');
    var emptyEl = document.getElementById('film-dialog-services-empty');
    var synopsisEl = document.getElementById('film-dialog-synopsis');
    var tmdbLinkEl = document.getElementById('film-dialog-tmdb-link');

    var title = card.dataset.filmTitle || '';
    var year = card.dataset.filmYear || '';
    var genres = (card.dataset.filmGenres || '').split('||').filter(Boolean);
    var runtime = formatRuntime(card.dataset.runtimeMinutes || '');
    var language = formatLanguage(card.dataset.originalLanguage || '');
    var certification = card.dataset.certification || '';
    var overview = (card.dataset.overview || '').trim();
    var tmdbLink = card.dataset.watchLink || '';
    var platforms = getCardPlatforms(card);
    var activePlatforms = platforms.filter(function (p) { return enabled.has(p.provider_id); });
    var otherPlatforms = platforms.filter(function (p) { return !enabled.has(p.provider_id); });

    if (titleEl) titleEl.textContent = title || 'Film details';

    if (yearEl) {
      yearEl.textContent = year;
      yearEl.hidden = !year;
    }
    if (genresEl) {
      genresEl.textContent = genres.join(' • ');
      genresEl.hidden = genres.length === 0;
    }
    if (runtimeWrap && runtimeEl) {
      runtimeEl.textContent = runtime;
      runtimeWrap.hidden = !runtime;
    }
    if (languageWrap && languageEl) {
      languageEl.textContent = language;
      languageWrap.hidden = !language;
    }
    if (certificationWrap && certificationEl) {
      certificationEl.textContent = certification;
      certificationWrap.hidden = !certification;
    }

    if (activeEl && activeWrap) {
      activeEl.innerHTML = activePlatforms.map(function (p) { return renderServiceChip(p, true); }).join('');
      activeWrap.hidden = activePlatforms.length === 0;
    }
    if (otherEl && otherWrap) {
      otherEl.innerHTML = otherPlatforms.map(function (p) { return renderServiceChip(p, false); }).join('');
      otherWrap.hidden = otherPlatforms.length === 0;
    }
    if (emptyEl) emptyEl.hidden = (activePlatforms.length + otherPlatforms.length) > 0;
    if (window.applyPlatformBadgeColours) window.applyPlatformBadgeColours(filmDialog);

    if (synopsisEl) {
      synopsisEl.textContent = overview || 'No synopsis available.';
    }

    if (tmdbLinkEl) {
      if (tmdbLink) {
        tmdbLinkEl.href = tmdbLink;
        tmdbLinkEl.hidden = false;
        tmdbLinkEl.classList.remove('pointer-events-none', 'opacity-50');
        tmdbLinkEl.setAttribute('aria-disabled', 'false');
      } else {
        tmdbLinkEl.href = '#';
        tmdbLinkEl.hidden = true;
        tmdbLinkEl.classList.add('pointer-events-none', 'opacity-50');
        tmdbLinkEl.setAttribute('aria-disabled', 'true');
      }
    }

    filmDialog.showModal();
  }

  function update() {
    applyActiveChips();
    applyDialogStates();
    classify();
    filterPlatforms();
    updatePlatformSummaries();
    applyViewMode();
    saveEnabled(enabled);
  }

  // --- Dialog ---
  var dialog = document.getElementById('services-dialog');
  var manageBtn = document.getElementById('manage-btn');
  var closeBtn = document.getElementById('dialog-close');
  var doneBtn = document.getElementById('dialog-done');
  var dialogAll = document.getElementById('dialog-all');
  var dialogNone = document.getElementById('dialog-none');
  var dialogSheet = dialog ? dialog.querySelector('.services-dialog-sheet') : null;
  var filmDialog = document.getElementById('film-dialog');
  var filmDialogClose = document.getElementById('film-dialog-close');
  var filmDialogSheet = filmDialog ? filmDialog.querySelector('.services-dialog-sheet') : null;

  if (manageBtn && dialog) {
    manageBtn.addEventListener('click', function () { dialog.showModal(); });
  }
  if (closeBtn) closeBtn.addEventListener('click', function () { dialog.close(); });
  if (doneBtn) doneBtn.addEventListener('click', function () { dialog.close(); });

  // Close on backdrop click (clicks on the dialog element outside its sheet)
  if (dialog && dialogSheet) {
    dialogSheet.addEventListener('click', function (e) { e.stopPropagation(); });
    dialog.addEventListener('click', function () { dialog.close(); });
  }

  if (dialogAll) dialogAll.addEventListener('click', function () { enabled = new Set(allIds); update(); });
  if (dialogNone) dialogNone.addEventListener('click', function () { enabled = new Set(); update(); });

  checkboxes.forEach(function (cb) {
    cb.addEventListener('change', function () {
      var id = parseInt(cb.dataset.providerId);
      if (cb.checked) { enabled.add(id); } else { enabled.delete(id); }
      update();
    });
  });

  document.querySelectorAll('.film-card[data-film-popup-trigger="true"]').forEach(function (card) {
    card.addEventListener('click', function () { openFilmDialog(card); });
    card.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openFilmDialog(card);
      }
    });
  });

  viewModeButtons.forEach(function (btn) {
    btn.addEventListener('click', function () {
      var nextMode = btn.dataset.viewModeBtn;
      if (nextMode !== 'grid' && nextMode !== 'list') return;
      if (viewMode === nextMode) return;
      viewMode = nextMode;
      saveViewMode(viewMode);
      applyViewMode();
    });
  });

  if (filmDialogClose) filmDialogClose.addEventListener('click', function () { filmDialog.close(); });
  if (filmDialog && filmDialogSheet) {
    filmDialogSheet.addEventListener('click', function (e) { e.stopPropagation(); });
    filmDialog.addEventListener('click', function () { filmDialog.close(); });
  }

  update();
})();

// --- Refresh button ---
(function () {
  var btn = document.getElementById('refresh-btn');
  if (!btn) return;

  var pollInterval = null;

  function setRefreshing(on) {
    btn.disabled = on;
    btn.querySelector('span.hidden, span.sm\\:inline') && (btn.querySelector('span.hidden, span.sm\\:inline').textContent = on ? 'Refreshing…' : 'Refresh');
  }

  function pollUntilDone() {
    pollInterval = setInterval(function () {
      fetch('/status').then(function (r) { return r.json(); }).then(function (data) {
        if (!data.is_refreshing) {
          clearInterval(pollInterval);
          window.location.reload();
        }
      }).catch(function () { clearInterval(pollInterval); setRefreshing(false); });
    }, 2000);
  }

  // If the page loaded while already refreshing, start polling immediately
  if (btn.disabled) {
    pollUntilDone();
  }

  btn.addEventListener('click', function () {
    setRefreshing(true);
    fetch('/refresh', { method: 'POST' })
      .then(function (r) { return r.json(); })
      .then(function () { pollUntilDone(); })
      .catch(function () { setRefreshing(false); });
  });
})();

// --- Platform badge colours ---
(function () {
  var PROVIDER_COLOURS = {
    8:   { text: '#ef4444', bg: 'rgba(239,68,68,0.12)' },    // Netflix
    9:   { text: '#60a5fa', bg: 'rgba(96,165,250,0.12)' },   // Amazon Prime Video
    337: { text: '#93c5fd', bg: 'rgba(147,197,253,0.12)' },  // Disney+
    350: { text: '#e2e8f0', bg: 'rgba(255,255,255,0.1)' },   // Apple TV+
    11:  { text: '#c084fc', bg: 'rgba(192,132,252,0.12)' },  // MUBI
    384: { text: '#eab308', bg: 'rgba(234,179,8,0.12)' },    // Max
    15:  { text: '#93c5fd', bg: 'rgba(147,197,253,0.12)' },  // Hulu
    531: { text: '#60a5fa', bg: 'rgba(96,165,250,0.12)' },   // Paramount+
  };
  var DEFAULT_COLOUR = { text: '#94a3b8', bg: 'rgba(148,163,184,0.1)' };

  window.applyPlatformBadgeColours = function (root) {
    (root || document).querySelectorAll('.platform-badge[data-provider-id]').forEach(function (el) {
      var id = parseInt(el.dataset.providerId);
      var c = PROVIDER_COLOURS[id] || DEFAULT_COLOUR;
      el.style.color = c.text;
      el.style.background = c.bg;
    });
  };

  window.applyPlatformBadgeColours(document);
})();

// --- Search ---
(function () {
  var input = document.getElementById('search-input');
  if (!input) return;
  input.addEventListener('input', function () {
    var q = input.value.trim().toLowerCase();
    document.querySelectorAll('.film-card').forEach(function (card) {
      var title = (card.dataset.title || '').toLowerCase();
      card.style.display = (!q || title.includes(q)) ? '' : 'none';
    });
  });
})();

</script>
</body>
</html>
